---
title: "Trade2"
author: "Aleksandr Matrunich"
date: "August 8, 2015"
output: pdf_document
---

```{r set_options, echo = F}
suppressPackageStartupMessages(library(dplyr))
library(ggvis)

knitr::opts_chunk$set(list(echo = FALSE,
                           eval = TRUE,
                           cache = TRUE,
                           warning = FALSE,
                           message = FALSE,
                           fig.height = 10,
                           fig.width = 12))

hostname <- Sys.getenv("HOSTNAME")
if(!is.element(hostname, c("matrunichstation", "sasmobile2.sasdomain"))) 
  stop("Uknown workstation. Aborting.")

if(hostname == "sasmobile2.sasdomain") projects_dir <- "fao"

subdir <- "OrangeBook"
sourcedir <- "tradeR"

if(length(lapply(dir(file.path(Sys.getenv("HOME"), projects_dir, "privateFAO", subdir, sourcedir), 
                     full.names = T), 
                 source)) == 0) stop("Files for sourcing not found")

if(hostname == "sasmobile2.sasdomain") 
  orange <- readRDS(file.path(Sys.getenv("HOME"), 
                              projects_dir, 
                              "trade_prevalid_testing",
                              "tariffline_agri_orange.Rds"))

comtrade_areas <- getComtradeM49() %>% 
  mutate(
    common_name = countrycode::countrycode(name,
                                           "country.name",
                                           "country.name",
                                           warn = T))
official_areas <- getOfficialM49() %>% 
  mutate(
    # We take iso3 as source because it provides the best cover (only 2 NA)
    common_name = countrycode::countrycode(iso3,
                                             "iso3c",
                                             "country.name",
                                             warn = T))

orange <- orange %>% 
  left_join(getComtradeM49()  %>%
              mutate(
                reporter_name = countrycode::countrycode(name,
                                                       "country.name",
                                                       "country.name",
                                                       warn = T)) %>% 
              select(-name),
            by= c("reporter" = "code")) %>% 
  left_join(getOfficialM49() %>% 
              select(-name) %>% 
              mutate(
                # We take iso3 as source because it provides the best cover (only 2 NA)
                partner_name = countrycode::countrycode(iso3,
                                                        "iso3c",
                                                        "country.name",
                                                        warn = T)) %>% 
              select(-iso3),
            by = c("partner" = "code"))
```

# Initial validation of trade data

At prevalidation step we are to make a decision should we accept data from a specific country for the further processing or not. A country could provide data of good quality for one part of commodities and inadequate level of quality for another part. We want to estimate quality differences between commodities of a country.

Quality of data is estimated by following indicators:

* Share per cent of missing quantities
* Share per cent of unit value outliers


## Self-trade

There are cases when a country reports itself as a partner to exports or imports. Such situations can occur due to mistakes or when an entrepÃ´t exists.

```{r examples_of_selftrade}
orange %>% 
  filter(reporter_name == partner_name) %>% 
  group_by(reporter_name, flow) %>% 
  summarize(ntradeflows = n()) %>% 
  ungroup() %>% 
  arrange(desc(ntradeflows)) %>% 
  mutate(flow = factor(flow, levels = c(1, 2), 
                       labels = c("Import", "Export"))) %>% 
  rename(Reporter = reporter_name, 
         Flow = flow, 
         Total = ntradeflows) %>% 
  printTab(caption = "Self-trade of commodities from 2nd, 10th and 15th HS chapters in 2011")
```

## Missing indicators

We identify which reporters provide data of insufficient quality. Firstly for every reporter proportion of trade flows with missing quantity is calculated. 

```{r}
no_quant_threshold <- .02

orange <- orange %>% 
  mutate(no_quant = missingIndicator(weight, NA) &
           missingIndicator(qty, NA))  

missing_qty <- orange %>% 
  group_by(reporter_name) %>% 
  summarize(missing_prop = sum(no_quant) / n()) %>% 
  ungroup() %>% 
  filter(missing_prop > no_quant_threshold) %>% 
  arrange(desc(missing_prop))

missing_qty %>% 
  ggvis(x = ~missing_prop,
        y = ~reporter_name) %>% 
  layer_points() %>% 
    add_axis("x", 
             title = "Trade flows with missing quantity (HS 02, 10, 15)",
             format = "%") %>% 
  add_axis("y", title = "") 
```


## Detection of outliers

## Imputing of missing quantities and replacement of outliers